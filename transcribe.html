<!DOCTYPE html>
<html>
    <head>
        <style>

            * { margin: 0; padding: 0; font-family: sans-serif; font-size: 12pt; color: #1e2f55; box-sizing: border-box; }
            html, body { width: 100%; height: 100%; }
            body { padding: 32px 16px 32px 32px; display: flex; flex-direction: column; }

            h1 { font-size: 24pt; margin-bottom: 24px; }
            h2 { font-size: 18pt; font-weight: normal; margin-bottom: 12px; }

            .content { display: flex; flex-direction: row; flex: 1; }

            .leftcolumn { flex: 1; display: flex; flex-direction: column; margin-right: 16px; }
            .rightcolumn { flex: 1; display: flex; flex-direction: column; margin-left: 16px; }

            input { border: 1px dashed #888888; margin: 0 auto; padding: 40px; border-radius: 5px; background: #fafafa; }
            button { background: #f1f2f4; border: none; border-radius: 3px; padding: 8px; cursor: pointer; margin: 16px auto; }
            button:hover { background-color: #d5d6d8; }

            .result { flex: 1; border: 1px solid #dddddd; padding: 4px; line-break: anywhere; }


        </style>
        <script type="module">

            import TASKBRIDGE from './taskbridge.js'

            var taskidtowaitfor = undefined
            var targetdiv = document.querySelector(".result")
            const fileInput = document.querySelector(".file")

            function statusCallback(taskStatus) {
                targetdiv.innerText = `Waiting for result of task ${taskidtowaitfor} (${taskStatus.status}${taskStatus.progress ? " " + taskStatus.progress + "%" : ""}) ...`
            }

            function completionCallback(taskResult) {
                if (taskResult) {
                    var texts = taskResult.texts
                    targetdiv.innerHTML = texts.map(text => text.text).join("<br/>")
                }
                localStorage.removeItem("transcribe-taskidtowaitfor")
            }

            async function transcribe() {

                var file = fileInput.files[0]

                targetdiv.innerText = `Uploading file ${file.name} ...`

                var addResult = await TASKBRIDGE.addTask('transcribe', undefined, file)

                taskidtowaitfor = addResult.id

                localStorage.setItem("transcribe-taskidtowaitfor", taskidtowaitfor)

                TASKBRIDGE.waitForTaskCompletion(taskidtowaitfor, statusCallback, completionCallback)

            }

            var lasttaskidtowaitfor = localStorage.getItem("transcribe-taskidtowaitfor")
            if (lasttaskidtowaitfor) {
                TASKBRIDGE.waitForTaskCompletion(lasttaskidtowaitfor, statusCallback, completionCallback)
            }

            document.querySelector(".start").addEventListener("click", transcribe)

            fileInput.addEventListener("change", () => {
                console.log(fileInput.files)
            })

        </script>
    </head>
    <body>

        <h1>Transcribe</h1>

        <div class="content">

            <div class="leftcolumn">
                <h2>Source</h2>

                <input type="file" class="file"/>

                <button class="start">Transcribe</button>

                <video controls></video>

                <audio controls></audio>
            </div>

            <div class="rightcolumn">
                <h2>Result</h2>

                <div class="result" contenteditable></div>
            </div>

        </div>

    </body>
</html>
